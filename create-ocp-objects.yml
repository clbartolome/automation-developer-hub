---
- name: Test application deployment on OCP
  hosts: localhost
  gather_facts: false
  vars:
    cluster_namespace: "hello-openshift"

  tasks:
    - name: Get Ingress Info
      kubernetes.core.k8s_info:
        api_version: config.openshift.io/v1
        kind: Ingress
        name: cluster
        validate_certs: false
      register: ingress_info

    - name: Set Ingress domain
      ansible.builtin.set_fact:
        ingress_domain: "{{ ingress_info | json_query('resources[*].spec.domain') | list | first | string }}"

    - name: Create namespace
      kubernetes.core.k8s:
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ cluster_namespace }}"
        state: present
        validate_certs: false

    - name: Create resource using name generated by the server
      kubernetes.core.k8s:
        state: present
        namespace: "{{ cluster_namespace }}"
        template:
          path: templates/hello-openshift.yml.j2
        validate_certs: false

    - name: Wait for application to start serving
      ansible.builtin.uri:
        url: http://hello.{{ ingress_domain }}
        method: GET
        return_content: true
        status_code: 200
      register: uri_output
      until: '"Hello OpenShift!" in uri_output.content'
      retries: 10
      delay: 10
